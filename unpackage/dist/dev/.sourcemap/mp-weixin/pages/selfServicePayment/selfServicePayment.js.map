{"version":3,"sources":["uni-app:///main.js","webpack:///D:/HongLongApp/pages/selfServicePayment/selfServicePayment.vue?3808","webpack:///D:/HongLongApp/pages/selfServicePayment/selfServicePayment.vue?0b49","webpack:///D:/HongLongApp/pages/selfServicePayment/selfServicePayment.vue?cb21","webpack:///D:/HongLongApp/pages/selfServicePayment/selfServicePayment.vue?0400","uni-app:///pages/selfServicePayment/selfServicePayment.vue","webpack:///D:/HongLongApp/pages/selfServicePayment/selfServicePayment.vue?afb6"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","renderjs","component","options","__file","components","uniForms","uniFormsItem","uniEasyinput","uniFilePicker","e","message","indexOf","console","error","render","_vm","this","_h","$createElement","_self","_c","recyclableRender","staticRenderFns","_withStripped","data","photoMaxB","photoMinB","isNeedScan","deviceId","characteristics","service","characteristicId_2","connected","boxInfo","ShellId","BoxId","DeviceModel","HWVersion","SWVersion","boxAmountInfo","PaperSum","CoinSum","Total","operationProcess","recordFromData","BoxAmount","PhotoVoucher","customRules","rules","required","errorMessage","pattern","deviceMACAddress","staffInfo","SecretKey","PhoneNum","onLoad","uni","frontColor","backgroundColor","animation","duration","timingFunc","watch","methods","autoConnect","mask","title","mode","success","fail","icon","onBluetoothAdapterStateChange","startBluetoothDevicesDiscovery","allowDuplicatesKey","onBluetoothDeviceFound","res","length","that","createBLEConnection","Command","complete","getBLEDeviceServices","getBLEDeviceCharacteristics","serviceId","notifyBLECharacteristicValueChange","indicate","characteristicId","state","type","scanCode","onlyFromCamera","getPhoneNumber","numberRes","phoneNum","result","timeBCDArr","shellInfo","routeArr","getBaseStaffInfoForApp","shellId","getShellInfo","responseResult","routeName","vehicleCode","signIn","idHexArr","signOut","unBox","isNeedRequest","order","deviceRecord","apiData","item","selectPhoto","deletePhoto","submit","photoVoucher"],"mappings":"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","file":"pages/selfServicePayment/selfServicePayment.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/selfServicePayment/selfServicePayment.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./selfServicePayment.vue?vue&type=template&id=4490bf26&\"\nvar renderjs\nimport script from \"./selfServicePayment.vue?vue&type=script&lang=js&\"\nexport * from \"./selfServicePayment.vue?vue&type=script&lang=js&\"\nimport style0 from \"./selfServicePayment.vue?vue&type=style&index=0&lang=scss&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/selfServicePayment/selfServicePayment.vue\"\nexport default component.exports","export * from \"-!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--17-0!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./selfServicePayment.vue?vue&type=template&id=4490bf26&\"","var components\ntry {\n  components = {\n    uniForms: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-forms/components/uni-forms/uni-forms\" */ \"@/uni_modules/uni-forms/components/uni-forms/uni-forms.vue\"\n      )\n    },\n    uniFormsItem: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-forms/components/uni-forms-item/uni-forms-item\" */ \"@/uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.vue\"\n      )\n    },\n    uniEasyinput: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput\" */ \"@/uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.vue\"\n      )\n    },\n    uniFilePicker: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker\" */ \"@/uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker.vue\"\n      )\n    },\n  }\n} catch (e) {\n  if (\n    e.message.indexOf(\"Cannot find module\") !== -1 &&\n    e.message.indexOf(\".vue\") !== -1\n  ) {\n    console.error(e.message)\n    console.error(\"1. 排查组件名称拼写是否正确\")\n    console.error(\n      \"2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom\"\n    )\n    console.error(\n      \"3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件\"\n    )\n  } else {\n    throw e\n  }\n}\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./selfServicePayment.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./selfServicePayment.vue?vue&type=script&lang=js&\"","<template>\r\n\t<view class=\"content\">\r\n\t\t<view v-if=\"operationProcess == '获取手机号'\" class=\"mask\">\r\n\t\t\t<button v-if=\"isNeedScan == true\" @click=\"scanCode\">扫码</button>\r\n\t\t\t<button v-else open-type=\"getPhoneNumber\" @getphonenumber=\"getPhoneNumber\">获取手机号</button>\r\n\t\t</view>\r\n\t\t<view v-if=\"operationProcess == '自助交账'\" class=\"operation\">\r\n\t\t\t<view class=\"boxInfo\">\r\n\t\t\t\t<view>{{'外箱编号：' + boxInfo.ShellId }}</view>\r\n\t\t\t\t<view>{{'内胆编号：' + boxInfo.BoxId }}</view>\r\n\t\t\t\t<view>{{'设备型号：' + boxInfo.DeviceModel }}</view>\r\n\t\t\t\t<view>{{'硬件版本：' + boxInfo.HWVersion }}</view>\r\n\t\t\t\t<view>{{'软件版本：' + boxInfo.SWVersion }}</view>\r\n\t\t\t</view>\r\n\r\n\t\t\t<!-- 操作->签到、签退、开箱 -->\r\n\t\t\t<button type=\"primary\" @click=\"getShellInfo\" :disabled=\"!connected\">获取投币机信息</button>\r\n\t\t\t<button type=\"primary\" @click=\"signIn\" :disabled=\"!connected\">签到</button>\r\n\t\t\t<button type=\"primary\" @click=\"signOut\" :disabled=\"!connected\">签退</button>\r\n\t\t\t<button type=\"primary\" @click=\"unBox\" :disabled=\"!connected\">开箱</button>\r\n\t\t</view>\r\n\t\t<view v-if=\"operationProcess == '提交'\" class=\"payment\">\r\n\t\t\t<view class=\"boxAmountInfo\">\r\n\t\t\t\t<view class=\"title\">原箱内数据展示</view>\r\n\t\t\t\t<view>{{ '纸币金额：' + boxAmountInfo.PaperSum }}</view>\r\n\t\t\t\t<view>{{ '硬币金额：' + boxAmountInfo.CoinSum }}</view>\r\n\t\t\t\t<view>{{ '总金额：' + boxAmountInfo.Total }}</view>\r\n\t\t\t</view>\r\n\r\n\t\t\t<uni-forms class=\"recordFrom\" ref=\"recordFrom\" :rules=\"customRules\" :modelValue=\"recordFormData\"\r\n\t\t\t\tlabel-position=\"top\">\r\n\t\t\t\t<uni-forms-item label=\"箱内金额\" required name=\"BoxAmount\">\r\n\t\t\t\t\t<uni-easyinput maxlength=\"6\" v-model=\"recordFormData.BoxAmount\" placeholder=\"请输入箱内金额\" />\r\n\t\t\t\t</uni-forms-item>\r\n\t\t\t\t<uni-forms-item label=\"照片凭证\" required name=\"PhotoVoucher\">\r\n\t\t\t\t\t<uni-file-picker v-model=\"recordFormData.PhotoVoucher\" return-type=\"array\" fileMediatype=\"image\"\r\n\t\t\t\t\t\tfile-extname=\"jpeg,jpg,png\" limit=\"3\" mode=\"grid\" auto-upload=\"false\" :sizeType=\"['compressed']\"\r\n\t\t\t\t\t\t:maxB=\"photoMaxB\" :minB=\"photoMinB\" @select=\"selectPhoto\" @delete=\"deletePhoto\" />\r\n\t\t\t\t</uni-forms-item>\r\n\t\t\t</uni-forms>\r\n\r\n\t\t\t<button type=\"default\" class=\"submit\" @click=\"submit\">提交</button>\r\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\timport {\r\n\t\tThrottle,\r\n\t\tSleep,\r\n\t\tProcessingQrCodeInfo,\r\n\t\tDecToHexStr,\r\n\t\tSplitHexString,\r\n\t\tPadArrayWithZeros,\r\n\t\tHexToDecStr,\r\n\t\tStrToHexString,\r\n\t\tGetImageBase64_ReadFile\r\n\t} from '@/utils/tool.js'\r\n\timport Command from '@/pages/selfServicePayment/command.js'\r\n\texport default {\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tphotoMaxB: this.$Global.StaffRegister_ImageMaxB,\r\n\t\t\t\tphotoMinB: 0, //this.$Global.StaffRegister_ImageMinB,\r\n\r\n\t\t\t\tisNeedScan: true,\r\n\r\n\t\t\t\t//蓝牙设备Id\r\n\t\t\t\tdeviceId: '',\r\n\t\t\t\t//蓝牙设备所有服务\r\n\t\t\t\tcharacteristics: [],\r\n\t\t\t\t//蓝牙设备通信服务\r\n\t\t\t\tservice: '',\r\n\t\t\t\t//0000FFF2（主机发送数据通道，发送数据将会再串口发送出去）\r\n\t\t\t\tcharacteristicId_2: '',\r\n\r\n\t\t\t\tconnected: false,\r\n\r\n\t\t\t\tboxInfo: {\r\n\t\t\t\t\tShellId: '0000000000',\r\n\t\t\t\t\tBoxId: '0000000000',\r\n\t\t\t\t\tDeviceModel: '未知',\r\n\t\t\t\t\tHWVersion: 'v0.0.0',\r\n\t\t\t\t\tSWVersion: 'v0.0.0'\r\n\t\t\t\t},\r\n\r\n\t\t\t\tboxAmountInfo: {\r\n\t\t\t\t\tPaperSum: '0.0',\r\n\t\t\t\t\tCoinSum: '0.0',\r\n\t\t\t\t\tTotal: '0.0'\r\n\t\t\t\t},\r\n\r\n\t\t\t\t//获取手机号、连接蓝牙、自助交账、提交\r\n\t\t\t\toperationProcess: '自助交账',\r\n\t\t\t\trecordFromData: {\r\n\t\t\t\t\tBoxAmount: '',\r\n\t\t\t\t\tPhotoVoucher: []\r\n\t\t\t\t},\r\n\t\t\t\tcustomRules: {\r\n\t\t\t\t\tBoxAmount: {\r\n\t\t\t\t\t\trules: [{\r\n\t\t\t\t\t\t\trequired: true,\r\n\t\t\t\t\t\t\terrorMessage: '单程票价不能为空'\r\n\t\t\t\t\t\t}, {\r\n\t\t\t\t\t\t\tpattern: '^([0-9]\\\\d*(\\\\.\\\\d+)?)$',\r\n\t\t\t\t\t\t\terrorMessage: '请输入正数最多一位小数'\r\n\t\t\t\t\t\t}]\r\n\t\t\t\t\t},\r\n\t\t\t\t\tPhotoVoucher: {\r\n\t\t\t\t\t\trules: [{\r\n\t\t\t\t\t\t\trequired: true,\r\n\t\t\t\t\t\t\terrorMessage: '至少上传一张照片'\r\n\t\t\t\t\t\t}]\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\r\n\t\t\t\tdeviceMACAddress: '383B265E9DD8',\r\n\r\n\t\t\t\tstaffInfo: {},\r\n\r\n\t\t\t\tSecretKey: [],\r\n\r\n\t\t\t\tPhoneNum: '15618693587'\r\n\t\t\t}\r\n\t\t},\r\n\t\tonLoad(query) {\r\n\t\t\tuni.setNavigationBarColor({\r\n\t\t\t\tfrontColor: '#ffffff',\r\n\t\t\t\tbackgroundColor: '#003366',\r\n\t\t\t\tanimation: {\r\n\t\t\t\t\tduration: 3000,\r\n\t\t\t\t\ttimingFunc: \"easeOut\"\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\tif (query.scene) {\r\n\t\t\t\tthis.isNeedScan = false\r\n\t\t\t\tconsole.log('自助交账入参', query)\r\n\r\n\t\t\t\tthis.deviceMACAddress = query.scene\r\n\t\t\t} else {\r\n\t\t\t\tthis.isNeedScan = true\r\n\t\t\t\tconsole.log('需要用户扫码')\r\n\t\t\t}\r\n\r\n\t\t\tthis.autoConnect()\r\n\t\t},\r\n\t\twatch: {\r\n\t\t\tconnected(newVal, oldVal) {\r\n\t\t\t\tif (newVal != oldVal) {\r\n\t\t\t\t\tif (newVal == true) {\r\n\t\t\t\t\t\t//this.load()\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\tasync autoConnect() {\r\n\t\t\t\tif (this.deviceMACAddress) {\r\n\t\t\t\t\tuni.showLoading({\r\n\t\t\t\t\t\tmask: true,\r\n\t\t\t\t\t\ttitle: '正在搜索设备中...'\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\t// 初始化蓝牙模块\r\n\t\t\t\t\tuni.openBluetoothAdapter({\r\n\t\t\t\t\t\tmode: 'central',\r\n\t\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\t\tconsole.log('蓝牙初始化成功', res)\r\n\t\t\t\t\t\t\tthis.onBluetoothAdapterStateChange()\r\n\r\n\t\t\t\t\t\t\tthis.startBluetoothDevicesDiscovery()\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\t\tconsole.log('蓝牙初始化失败', err)\r\n\r\n\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\t\ttitle: '请检查手机蓝牙是否打开'\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\tuni.hideLoading({\r\n\t\t\t\t\t\tfail: function(res) {\r\n\t\t\t\t\t\t\t//不加fail回调真机会报hideLoading的错误信息\r\n\t\t\t\t\t\t\t//console.log('报错了')\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t//搜索过程中检查蓝牙状态（监听）\r\n\t\t\tonBluetoothAdapterStateChange() {\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\t//搜索过程中检查蓝牙状态\r\n\t\t\t\tuni.onBluetoothAdapterStateChange(function(res) {\r\n\t\t\t\t\tif (res.available) {\r\n\t\t\t\t\t\tconsole.log('蓝牙适配器状态变为可用')\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.log('蓝牙适配器不可用，可能是蓝牙被关闭')\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t//开始搜索附近的蓝牙外围设备\r\n\t\t\tstartBluetoothDevicesDiscovery() {\r\n\t\t\t\tuni.startBluetoothDevicesDiscovery({\r\n\t\t\t\t\tallowDuplicatesKey: true,\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tconsole.log('开始搜索附近的蓝牙设备', res)\r\n\r\n\t\t\t\t\t\t//开始监听扫描新设备事件\r\n\t\t\t\t\t\tthis.onBluetoothDeviceFound()\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tconsole.log('搜索蓝牙设备失败', err)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t//搜索蓝牙设备（监听）\r\n\t\t\tonBluetoothDeviceFound() {\r\n\t\t\t\tconsole.log('搜索蓝牙设备（监听）')\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\t//监听搜索到新设备的事件\r\n\t\t\t\tuni.onBluetoothDeviceFound((res) => {\r\n\t\t\t\t\t//蓝牙搜索中关闭，则停止搜索\r\n\t\t\t\t\tif (that.deviceId) {\r\n\t\t\t\t\t\tconsole.log('取消搜索监听')\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t//更新蓝牙设备列表数据\r\n\t\t\t\t\tres.devices.forEach((device) => {\r\n\t\t\t\t\t\t// 名字前两位 != 'HJ'开头的设备排除\r\n\t\t\t\t\t\tif (device.name.slice(0, 2) != 'HJ' || device.name.length < that.deviceMACAddress\r\n\t\t\t\t\t\t\t.length) {\r\n\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tconsole.log('监听扫描到的设备', res.devices)\r\n\r\n\t\t\t\t\t\tif (device.name.substring(2, 14) == that.deviceMACAddress) {\r\n\t\t\t\t\t\t\tthat.createBLEConnection(device.deviceId)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tcreateBLEConnection(deviceId) {\r\n\t\t\t\tuni.createBLEConnection({\r\n\t\t\t\t\tdeviceId: deviceId,\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tif (this.deviceId) {\r\n\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tthis.deviceId = deviceId\r\n\t\t\t\t\t\tCommand.DeviceId = this.deviceId\r\n\t\t\t\t\t\tconsole.log('连接成功', res)\r\n\r\n\t\t\t\t\t\tuni.stopBluetoothDevicesDiscovery()\r\n\r\n\t\t\t\t\t\t//发现蓝牙设备上的服务  \r\n\t\t\t\t\t\tthis.getBLEDeviceServices()\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (res) => {\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\ttitle: '连接失败'\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\tconsole.log('连接失败')\r\n\t\t\t\t\t},\r\n\t\t\t\t\tcomplete: (com) => {\r\n\t\t\t\t\t\tuni.hideLoading({\r\n\t\t\t\t\t\t\tfail: function(res) {\r\n\t\t\t\t\t\t\t\t//不加fail回调真机会报hideLoading的错误信息\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t//获取蓝牙低功耗设备所有服务\r\n\t\t\tgetBLEDeviceServices() {\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\tuni.getBLEDeviceServices({\r\n\t\t\t\t\tdeviceId: that.deviceId, // 搜索到设备的 deviceId\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tif (that.service) {\r\n\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tfor (let i = 0; i < res.services.length; i++) {\r\n\t\t\t\t\t\t\tconsole.log('获取蓝牙低功耗设备所有服务成功', res.services)\r\n\r\n\t\t\t\t\t\t\t// 可根据具体业务需要，选择一个主服务进行通信（透传服务的UUID为0xFFF0）\r\n\t\t\t\t\t\t\tif (res.services[i].uuid.indexOf('0000FFF0') >= 0) {\r\n\t\t\t\t\t\t\t\tthat.service = res.services[i]\r\n\t\t\t\t\t\t\t\tCommand.ServiceId = that.service.uuid\r\n\t\t\t\t\t\t\t\tthat.getBLEDeviceCharacteristics()\r\n\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tconsole.log('获取蓝牙低功耗设备所有服务失败', err)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t//获取蓝牙低功耗设备某个服务中所有特征 (characteristic)\r\n\t\t\tgetBLEDeviceCharacteristics() {\r\n\t\t\t\tuni.getBLEDeviceCharacteristics({\r\n\t\t\t\t\tdeviceId: this.deviceId,\r\n\t\t\t\t\tserviceId: this.service.uuid,\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tconsole.log('获取特征成功', res.characteristics)\r\n\t\t\t\t\t\tthis.characteristics = res.characteristics\r\n\r\n\t\t\t\t\t\tfor (var i = 0; i < res.characteristics.length; i++) {\r\n\t\t\t\t\t\t\tvar item = res.characteristics[i]\r\n\r\n\t\t\t\t\t\t\tif (item.uuid.indexOf('0000FFF2') >= 0) {\r\n\t\t\t\t\t\t\t\tthis.characteristicId_2 = item.uuid\r\n\t\t\t\t\t\t\t\tCommand.CharacteristicId = this.characteristicId_2\r\n\t\t\t\t\t\t\t} else if (item.uuid.indexOf('0000FFF3') >= 0) {}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t//启用蓝牙低功耗设备特征值变化时的 notify 功能，订阅特征\r\n\t\t\t\t\t\tthis.notifyBLECharacteristicValueChange()\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tconsole.log('获取特征失败', err)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t//启用蓝牙低功耗设备特征值变化时的 notify 功能，订阅特征\r\n\t\t\tnotifyBLECharacteristicValueChange() {\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\tfor (var i = 0; i < that.characteristics.length; i++) {\r\n\t\t\t\t\tif (that.characteristics[i].properties.notify || that.characteristics[i].properties\r\n\t\t\t\t\t\t.indicate) {\r\n\t\t\t\t\t\tuni.notifyBLECharacteristicValueChange({\r\n\t\t\t\t\t\t\tdeviceId: that.deviceId,\r\n\t\t\t\t\t\t\tserviceId: that.service.uuid,\r\n\t\t\t\t\t\t\tcharacteristicId: that.characteristics[i].uuid,\r\n\t\t\t\t\t\t\tstate: true,\r\n\t\t\t\t\t\t\ttype: 'notification',\r\n\t\t\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\t\t\t//连接成功\r\n\t\t\t\t\t\t\t\tconsole.log('启用notify成功', res)\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\t\t\t//连接失败\r\n\t\t\t\t\t\t\t\tconsole.log('启用notify失败', err)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.connected = true\r\n\t\t\t},\r\n\t\t\tscanCode() {\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\tuni.scanCode({\r\n\t\t\t\t\tonlyFromCamera: true,\r\n\t\t\t\t\tsuccess(res) {\r\n\t\t\t\t\t\tconsole.log(res)\r\n\t\t\t\t\t\tvar val = ProcessingQrCodeInfo(res, that.$mp.page.route)\r\n\t\t\t\t\t\tconsole.log('蓝牙地址', val)\r\n\t\t\t\t\t\tif (val) {\r\n\t\t\t\t\t\t\tthat.deviceMACAddress = val\r\n\t\t\t\t\t\t\tthat.isNeedScan = false\r\n\r\n\t\t\t\t\t\t\tthat.operationProcess = '自助交账'\r\n\t\t\t\t\t\t\tthat.autoConnect()\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\t\ttitle: '请扫描正确的二维码'\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail(res) {\r\n\t\t\t\t\t\tconsole.log(res)\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\ttitle: '未扫描二维码'\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t//获取用户的手机号\r\n\t\t\tasync getPhoneNumber(e) {\r\n\t\t\t\tvar that = this\r\n\t\t\t\tconsole.log('获取手机号code', e.detail.code)\r\n\r\n\t\t\t\tif (e.detail.code) {\r\n\r\n\t\t\t\t\t//根据code换取用户的手机号\r\n\t\t\t\t\tvar numberRes = await that.$WXApi.GetPhoneNumber({\r\n\t\t\t\t\t\t'code': e.detail.code\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\tconsole.log('请求获取手机号接口', numberRes)\r\n\t\t\t\t\tif (numberRes.result) {\r\n\t\t\t\t\t\tif (numberRes.result.errcode == 0) {\r\n\t\t\t\t\t\t\t//获取到用户的手机号不含区号\r\n\t\t\t\t\t\t\tvar phoneNum = numberRes.result.phone_info.purePhoneNumber\r\n\r\n\t\t\t\t\t\t\t//根据手机号查询用户信息\r\n\t\t\t\t\t\t\tvar result = that.getBaseStaffInfoForApp(phoneNum)\r\n\t\t\t\t\t\t\tif (result && result.success == true) {\r\n\t\t\t\t\t\t\t\t//认证通过后自动连接蓝牙\r\n\t\t\t\t\t\t\t\tthat.autoConnect()\r\n\r\n\t\t\t\t\t\t\t\tvar data = ['01']\r\n\t\t\t\t\t\t\t\tvar timeBCDArr = Command.GetCurrentTimeAsBCDArr()\r\n\t\t\t\t\t\t\t\tdata = data.concat(timeBCDArr)\r\n\r\n\t\t\t\t\t\t\t\t//data.unshift('01')//只更新时间 '0F'全部更新\r\n\r\n\t\t\t\t\t\t\t\tvar shellInfo = await Command.WriteBLEAndWaitForResponse(Command.CmdId.GetShellInfo,\r\n\t\t\t\t\t\t\t\t\tdata)\r\n\t\t\t\t\t\t\t\t//根据蓝牙获取到的投币机ID，再次调用getBaseStaffInfoForApp，获取员工、线路、车辆信息\r\n\t\t\t\t\t\t\t\tif (shellInfo.Status == true) {\r\n\t\t\t\t\t\t\t\t\tresult = that.getBaseStaffInfoForApp(phoneNum, shellInfo.ShellId)\r\n\r\n\t\t\t\t\t\t\t\t\tif (result && result.success == true) {\r\n\t\t\t\t\t\t\t\t\t\tdata = ['0F']\r\n\t\t\t\t\t\t\t\t\t\ttimeBCDArr = Command.GetCurrentTimeAsBCDArr()\r\n\t\t\t\t\t\t\t\t\t\tdata = data.concat(timeBCDArr)\r\n\r\n\t\t\t\t\t\t\t\t\t\tdata.push(DecToHexStr(result.ticketPrice))\r\n\r\n\t\t\t\t\t\t\t\t\t\tvar routeArr = Array(20).fill('00')\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\t\t\t\ttitle: '获取投币机信息失败-蓝牙'\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\t\ttitle: '获取手机号失败'\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.log('获取手机号无结果')\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tasync getBaseStaffInfoForApp(phoneNum, shellId = '') {\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\t'PhoneNum': phoneNum,\r\n\t\t\t\t\t'ShellID': shellId\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconsole.log('接口请求参数', data)\r\n\r\n\t\t\t\tvar result = await that.$Api.Staff_GetBaseStaffInfoForApp(data)\r\n\t\t\t\treturn result\r\n\t\t\t},\r\n\t\t\tasync getShellInfo() {\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\tvar phoneNum = '15618693587'\r\n\r\n\t\t\t\t//根据手机号查询用户信息\r\n\t\t\t\tvar res = await that.$Api.Staff_GetBaseStaffInfoForApp({\r\n\t\t\t\t\t'PhoneNum': '15618693587'\r\n\t\t\t\t})\r\n\t\t\t\t//var res = that.getBaseStaffInfoForApp(phoneNum, '')\r\n\t\t\t\tif (res) {\r\n\t\t\t\t\t//认证通过后自动连接蓝牙\r\n\t\t\t\t\t//that.autoConnect()\r\n\r\n\t\t\t\t\tconsole.log('获取员工信息成功', res)\r\n\r\n\t\t\t\t\tvar data = ['01'] //只更新时间\r\n\t\t\t\t\tvar timeBCDArr = Command.GetCurrentTimeAsBCDArr()\r\n\t\t\t\t\tconsole.log('时间数组', timeBCDArr)\r\n\t\t\t\t\tdata = data.concat(timeBCDArr)\r\n\r\n\t\t\t\t\t//data.unshift('01')//只更新时间 '0F'全部更新\r\n\r\n\t\t\t\t\tconsole.log('只更新时间-蓝牙请求', data)\r\n\r\n\t\t\t\t\tvar responseResult = await Command.WriteBLEAndWaitForResponse(Command.CmdId.GetShellInfo, data)\r\n\t\t\t\t\t//根据蓝牙获取到的投币机ID，再次调用getBaseStaffInfoForApp，获取员工、线路、车辆信息\r\n\r\n\t\t\t\t\tconsole.log('只更新时间-蓝牙回复', responseResult)\r\n\r\n\t\t\t\t\tif (responseResult.Status == true) {\r\n\t\t\t\t\t\tthat.boxInfo = responseResult.Data\r\n\t\t\t\t\t\tthat.SecretKey = responseResult.Data.SecretKey\r\n\r\n\t\t\t\t\t\tres = await that.$Api.Staff_GetBaseStaffInfoForApp({\r\n\t\t\t\t\t\t\t'PhoneNum': that.PhoneNum,\r\n\t\t\t\t\t\t\t'ShellID': responseResult.Data.ShellId\r\n\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\t\tif (res) {\r\n\t\t\t\t\t\t\tthat.staffInfo.staffCardID = res.result.staffCardID\r\n\t\t\t\t\t\t\tthat.staffInfo.vehicleCode = res.result.vehicleCode\r\n\t\t\t\t\t\t\tthat.staffInfo.routeName = res.result.routeName\r\n\t\t\t\t\t\t\tthat.staffInfo.ticketPrice = res.result.ticketPrice\r\n\r\n\t\t\t\t\t\t\tdata = ['0F'] //更新全部数据\r\n\r\n\t\t\t\t\t\t\t//当前时间\r\n\t\t\t\t\t\t\ttimeBCDArr = Command.GetCurrentTimeAsBCDArr()\r\n\t\t\t\t\t\t\tdata = data.concat(timeBCDArr)\r\n\r\n\t\t\t\t\t\t\t//票价\r\n\t\t\t\t\t\t\tdata.push(DecToHexStr(that.staffInfo.ticketPrice * 10))\r\n\r\n\t\t\t\t\t\t\t//线路号\r\n\t\t\t\t\t\t\tdata = data.concat(PadArrayWithZeros(SplitHexString(DecToHexStr(that.staffInfo\r\n\t\t\t\t\t\t\t\t.routeName)), 20))\r\n\r\n\t\t\t\t\t\t\t//车辆编号\r\n\t\t\t\t\t\t\tdata = data.concat(PadArrayWithZeros(SplitHexString(DecToHexStr(that.staffInfo\r\n\t\t\t\t\t\t\t\t.vehicleCode)), 12))\r\n\r\n\t\t\t\t\t\t\tresponseResult = await Command.WriteBLEAndWaitForResponse(Command.CmdId.GetShellInfo, data)\r\n\t\t\t\t\t\t\tconsole.log('信息全部更新-蓝牙回复', responseResult)\r\n\r\n\t\t\t\t\t\t\tif (responseResult.Status == true) {\r\n\t\t\t\t\t\t\t\tthat.SecretKey = responseResult.Data.SecretKey\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\ttitle: '获取投币机信息失败-蓝牙'\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tasync signIn() {\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\tvar data = ['01']\r\n\r\n\t\t\t\t//当前时间\r\n\t\t\t\tvar timeBCDArr = Command.GetCurrentTimeAsBCDArr()\r\n\t\t\t\tdata = data.concat(timeBCDArr)\r\n\r\n\t\t\t\t//驾驶员卡ID\r\n\t\t\t\tvar idHexArr = PadArrayWithZeros(SplitHexString(DecToHexStr(this.staffInfo.staffCardID)), 16)\r\n\t\t\t\tdata = data.concat(idHexArr)\r\n\r\n\t\t\t\t//加密秘钥\r\n\t\t\t\tdata = data.concat(this.SecretKey)\r\n\r\n\t\t\t\tvar responseResult = await Command.WriteBLEAndWaitForResponse(Command.CmdId.SignIn, data, this\r\n\t\t\t\t\t.SecretKey)\r\n\t\t\t\tconsole.log('驾驶员签到-蓝牙回复', responseResult)\r\n\t\t\t\tif (responseResult.Status == true) {\r\n\t\t\t\t\tthat.SecretKey = responseResult.Data.SecretKey\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tasync signOut() {\r\n\t\t\t\tvar data = ['01']\r\n\r\n\t\t\t\t//当前时间\r\n\t\t\t\tvar timeBCDArr = Command.GetCurrentTimeAsBCDArr()\r\n\t\t\t\tdata = data.concat(timeBCDArr)\r\n\r\n\t\t\t\t//驾驶员卡ID\r\n\t\t\t\tvar idHexArr = PadArrayWithZeros(SplitHexString(DecToHexStr(this.staffInfo.staffCardID)), 16)\r\n\t\t\t\tdata = data.concat(idHexArr)\r\n\r\n\t\t\t\t//加密秘钥\r\n\t\t\t\tdata = data.concat(this.SecretKey)\r\n\r\n\t\t\t\tvar responseResult = await Command.WriteBLEAndWaitForResponse(Command.CmdId.SignOut, data, this\r\n\t\t\t\t\t.SecretKey)\r\n\t\t\t\tconsole.log('驾驶员签退-蓝牙回复', responseResult)\r\n\t\t\t\tif (responseResult.Status == true) {\r\n\t\t\t\t\tthis.SecretKey = responseResult.Data.SecretKey\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tasync unBox() {\r\n\t\t\t\tvar isNeedRequest = true\r\n\t\t\t\tvar order = 1 //从1开始，重复操作必须保持序号不变，否则每次加1，256溢出归零\r\n\t\t\t\twhile (isNeedRequest) {\r\n\t\t\t\t\tvar data = ['01']\r\n\t\t\t\t\t\r\n\t\t\t\t\t//当前时间\r\n\t\t\t\t\tvar timeBCDArr = Command.GetCurrentTimeAsBCDArr()\r\n\t\t\t\t\tdata = data.concat(timeBCDArr)\r\n\r\n\t\t\t\t\t//驾驶员卡ID\r\n\t\t\t\t\tvar idHexArr = PadArrayWithZeros(SplitHexString(DecToHexStr(this.staffInfo.staffCardID)), 16)\r\n\t\t\t\t\tdata = data.concat(idHexArr)\r\n\r\n\t\t\t\t\t//状态码\r\n\t\t\t\t\tdata.push('01') //01：读数据;02：投币机开箱;\r\n\r\n\t\t\t\t\t//命令序号\r\n\t\t\t\t\tdata.push(order)\r\n\r\n\t\t\t\t\t//加密秘钥\r\n\t\t\t\t\tdata = data.concat(this.SecretKey)\r\n\r\n\t\t\t\t\tvar responseResult = await Command.WriteBLEAndWaitForResponse(Command.CmdId.UnBox, data, this\r\n\t\t\t\t\t\t.SecretKey)\r\n\t\t\t\t\tconsole.log('驾驶员开箱-蓝牙回复', responseResult)\r\n\t\t\t\t\tif (responseResult.Status == true) {\r\n\t\t\t\t\t\tthis.SecretKey = responseResult.Data.SecretKey\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//判断是否还有未读取记录\r\n\t\t\t\t\t\tisNeedRequest = responseResult.Data.UnreadDataRows > 0\r\n\r\n\t\t\t\t\t\tvar deviceRecord = responseResult.Data.DeviceRecord\r\n\t\t\t\t\t\tvar apiData = []\r\n\r\n\t\t\t\t\t\tif (deviceRecord.length > 0) {\r\n\t\t\t\t\t\t\tfor (var i = 0; i < deviceRecord.length; i++) {\r\n\t\t\t\t\t\t\t\tvar item = {\r\n\t\t\t\t\t\t\t\t\t\"actionOrder\": deviceRecord[i].Order, //记录序号\r\n\t\t\t\t\t\t\t\t\t\"recordType\": deviceRecord[i].Type, // 记录类型 1分班投币机记录 2当天投币记录\r\n\t\t\t\t\t\t\t\t\t\"recordTime\": deviceRecord[i].Time, // 记录时间\r\n\t\t\t\t\t\t\t\t\t\"signInTime\": deviceRecord[i].SignInTime, // 签到时间\r\n\t\t\t\t\t\t\t\t\t\"signOutTime\": deviceRecord[i].SignOutTime, // 签退时间\r\n\t\t\t\t\t\t\t\t\t\"shellID\": deviceRecord[i].ShellId, // 投币箱ID\r\n\t\t\t\t\t\t\t\t\t\"vehicleCode\": deviceRecord[i].VehicleCode, // 当时所属车辆编号\r\n\t\t\t\t\t\t\t\t\t\"routeName\": deviceRecord[i].Route, // 当时所属线路\r\n\t\t\t\t\t\t\t\t\t\"boxID\": deviceRecord[i].BoxId, // 内胆编号\r\n\t\t\t\t\t\t\t\t\t\"phoneNum\": this.PhoneNum, //手机号码\r\n\t\t\t\t\t\t\t\t\t\"staffCardID\": deviceRecord[i].StaffCardId, //驾驶员卡号\r\n\t\t\t\t\t\t\t\t\t\"paperAmount\": deviceRecord[i].Paper, // 纸币金额\r\n\t\t\t\t\t\t\t\t\t\"coinAmount\": deviceRecord[i].Coins, // 硬币金额\r\n\t\t\t\t\t\t\t\t\t\"peopleCount\": deviceRecord[i].PeopleCount, // 投币人次\r\n\t\t\t\t\t\t\t\t\t\"hasCounted\": false, //是否点钞\r\n\t\t\t\t\t\t\t\t\t\"countingAmount\": 0, //点钞金额\r\n\t\t\t\t\t\t\t\t\t\"foreignNum\": 0, //异币张数\r\n\t\t\t\t\t\t\t\t\t\"remark\": \"\", //备注\r\n\t\t\t\t\t\t\t\t\t\"ssCashierImages\": [] //照片\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\tapiData.push(item)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\torder += 1\r\n\t\t\t\t\t\tconsole.log('自助交账数据包', apiData)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t//选择照片\r\n\t\t\tselectPhoto(e) {\r\n\t\t\t\tconsole.log(e)\r\n\t\t\t},\r\n\t\t\t//删除照片\r\n\t\t\tdeletePhoto(e) {\r\n\t\t\t\tconsole.log(e)\r\n\t\t\t},\r\n\t\t\tsubmit: Throttle(function() {\r\n\t\t\t\tvar that = this\r\n\r\n\t\t\t\tthat.$refs.recordFrom.validate().then(res => {\r\n\t\t\t\t\tconsole.log('提交')\r\n\r\n\t\t\t\t\tvar photoVoucher = []\r\n\r\n\t\t\t\t\t//处理上传图片参数\r\n\t\t\t\t\tfor (var i = 0; i < that.recordFromData.PhotoVoucher.length; i++) {\r\n\t\t\t\t\t\tconsole.log(that.recordFromData.PhotoVoucher[i].path)\r\n\r\n\t\t\t\t\t\tvar path = that.recordFromData.PhotoVoucher[i].path\r\n\t\t\t\t\t\tGetImageBase64_ReadFile(path).then((res) => {\r\n\t\t\t\t\t\t\tphotoVoucher.push({\r\n\t\t\t\t\t\t\t\t'imageName': \"照片_\" + i + path.substring(path.indexOf('.')),\r\n\t\t\t\t\t\t\t\t'imageData': res\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\"recordTime\": Date.now(), // 记录时间\r\n\t\t\t\t\t\t\"shellID\": boxInfo.ShellId, // 投币箱ID\r\n\t\t\t\t\t\t\"vehicleCode\": that.staffInfo.vehicleCode, // 当时所属车辆编号\r\n\t\t\t\t\t\t\"routeName\": that.staffInfo.routeName, // 当时所属线路\r\n\t\t\t\t\t\t\"boxID\": boxInfo.BoxId, // 内胆编号\r\n\t\t\t\t\t\t\"phoneNum\": that.PhoneNum, //手机号码\r\n\t\t\t\t\t\t\"staffCardID\": that.staffInfo.staffCardID, //驾驶员卡号\r\n\t\t\t\t\t\t\"hasCounted\": true, //是否点钞\r\n\t\t\t\t\t\t\"countingAmount\": 0, //点钞金额\r\n\t\t\t\t\t\t\"foreignNum\": 0, //异币张数\r\n\t\t\t\t\t\t\"remark\": \"\", //备注\r\n\t\t\t\t\t\t\"ssCashierImages\": photoVoucher //照片\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tthis.$Api.SubmitSelfServiceCashier(JSON.stringify(data)).then((apiRes) => {\r\n\t\t\t\t\t\tif (result) {\r\n\t\t\t\t\t\t\tconsole.log('新增自助交账记录成功')\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}).catch(err => {\r\n\t\t\t\t\tconsole.log('err', err)\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n\tpage {\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\r\n\t\t.content {\r\n\t\t\twidth: inherit;\r\n\t\t\theight: inherit;\r\n\t\t\tdisplay: flex;\r\n\t\t\talign-items: center;\r\n\t\t\tjustify-content: center;\r\n\r\n\t\t\t.mask {\r\n\t\t\t\twidth: inherit;\r\n\r\n\t\t\t\tbutton {\r\n\t\t\t\t\twidth: 65%;\r\n\t\t\t\t\tcolor: white;\r\n\t\t\t\t\tborder-radius: 25rpx;\r\n\t\t\t\t\tfont-size: 50rpx;\r\n\t\t\t\t\tbackground: linear-gradient(-5deg, #00ccff, #003366);\r\n\t\t\t\t\theight: 170rpx;\r\n\t\t\t\t\tline-height: 170rpx;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t.operation {\r\n\t\t\t\twidth: 90%;\r\n\t\t\t\talign-items: center;\r\n\r\n\t\t\t\tview {\r\n\t\t\t\t\tmargin: 10rpx 0rpx;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tbutton {\r\n\t\t\t\t\tcolor: white;\r\n\t\t\t\t\tborder-radius: 25rpx;\r\n\t\t\t\t\tbackground: linear-gradient(-5deg, #00ccff, #003366);\r\n\t\t\t\t\tmargin: 50rpx 0rpx;\r\n\t\t\t\t\theight: 170rpx;\r\n\t\t\t\t\tline-height: 170rpx;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.boxInfo {\r\n\t\t\t\t\tborder: 2rpx solid #003366;\r\n\t\t\t\t\tborder-radius: 50rpx;\r\n\t\t\t\t\tpadding: 30rpx;\r\n\t\t\t\t\tcolor: #003366;\r\n\t\t\t\t\tfont-size: 42rpx;\r\n\t\t\t\t\tfont-weight: bolder;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t.payment {\r\n\t\t\t\twidth: 90%;\r\n\r\n\t\t\t\t.boxAmountInfo {\r\n\t\t\t\t\tcolor: #003366;\r\n\t\t\t\t\tborder: 2rpx solid #003366;\r\n\t\t\t\t\tborder-radius: 50rpx;\r\n\t\t\t\t\tpadding: 30rpx;\r\n\t\t\t\t\tmargin-bottom: 80rpx;\r\n\r\n\t\t\t\t\tview {\r\n\t\t\t\t\t\tfont-weight: bolder;\r\n\t\t\t\t\t\tmargin-bottom: 20rpx;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.title {\r\n\t\t\t\t\t\ttext-align: center;\r\n\t\t\t\t\t\tfont-size: 50rpx;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.submit {\r\n\t\t\t\t\tcolor: white;\r\n\t\t\t\t\tborder-radius: 60rpx;\r\n\t\t\t\t\tbackground: linear-gradient(-5deg, #00ccff, #003366);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</style>","import mod from \"-!../../../HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./selfServicePayment.vue?vue&type=style&index=0&lang=scss&\"; export default mod; export * from \"-!../../../HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./selfServicePayment.vue?vue&type=style&index=0&lang=scss&\""],"sourceRoot":""}